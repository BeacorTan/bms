<script th:src="@{/assets/module/call/socket.io.js}" language="JavaScript"></script>
<script th:src="@{/assets/module/call/jquery.wincall.v2.js}" language="javascript"></script>
<script th:src="@{/assets/module/call/jquery.md5.js}" language="javascript"></script>
<div class="container" style="width: 100%;margin-top: 20px;">

    <div class="row">
        <div class="col-md-1">
            <button id="call_btn_login" type="button" class="btn btn-primary">签入</button>
        </div>
        <div class="col-md-1">
            <button id="call_btn_logout" type="button" class="btn btn-danger" disabled="disabled">注销</button>
        </div>
    </div>

    <div class="row" style="margin-top: 10px;">
        <div class="col-md-4">
            <div class="form-group col-md-10" style="padding: 2px 0px;">
                <label class="sr-only"></label>
                <div class="input-group">
                    <div class="input-group-addon"><i class="fa fa-mobile"></i></div>
                    <input id="call_mobile" type="text" class="form-control" placeholder="手机号码">
                </div>

            </div>
            <div class="col-md-2" style="padding-left: 0px;">
                <button id="call_btn_dialouter" type="button" class="btn btn-primary" disabled="disabled">外呼</button>
            </div>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-primary" disabled="disabled">接听</button>
        </div>
        <div class="col-md-1">
            <button id="call_btn_hangup" type="button" class="btn btn-primary" disabled="disabled">挂断</button>
        </div>

        <div class="col-md-1">
            <button class="btn btn-primary" id="call_btn_busy" disabled>置忙</button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary" id="call_btn_transfer" disabled>转接</button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary" id="call_btn_hold" disabled>保持</button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary" id="call_btn_restore" disabled>恢复</button>
        </div>

    </div>
</div>
<script language="JavaScript">

    var busy_reasons = {};
    var wincall = null;
    $(document).ready(function () {
        var sockeIsLogin = false;

//        var wintel_server_ip = '172.30.32.51';
        var wintel_server_ip = CM_Components.dictByKey("SYSTEM_CONFIG","CALL_IP");


//        var vccCode = 'quark';
        var vccCode = CM_Components.dictByKey("SYSTEM_CONFIG","CALL_ENTERPRISE_CODE");
//        var wintelapi_url = 'http://172.30.32.51/manage/web/';
        var wintelapi_url = CM_Components.dictByKey("SYSTEM_CONFIG","CALL_REQUEST_URL");


        wincall = new WinCall({
            wintel_server_ip: wintel_server_ip,
            wintel_server_port: '6050',
            wintelapi_url: wintelapi_url,
            vcc_code: vccCode,
            busy_reasons: busy_reasons,
            debug: true,
            event_listener: eventListener
        });
        wincall.init();
        sockeIsLogin = true;

        // 获取企业配置的置忙原因
        $.ajax({
            url: wincall.opts.wintelapi_url + '/v2/wintelapi/api/busyreason/list',
            data: {vcc_code: wincall.opts.vcc_code},
            dataType: 'jsonp',
            timeout: 5000,
            async: false,
            jsonp: 'jsonpcallback',
            success: function (response) {
                var resCode = response.code || '';
                if (resCode == 200) {
                    $.each(response.data, function (index, value) {
                        busy_reasons[value.id] = value.stat_reason;
                    });
                } else {
                    wincall.log(response);
                }
            }
        });

        // 记录登录的信息
//        if (window.localStorage) {
//            window.localStorage.setItem('wintel_server_ip', wintel_server_ip);
//            window.localStorage.setItem('wintelapi_url', wintelapi_url);
//            window.localStorage.setItem('vccCode', vccCode);
//        }


        // 签入
        $('#call_btn_login').on('click', function () {

            var $login_name = $("#login_name").val();
            var agentNum = $login_name;
            var pwd=CM_Components.dictByKey("SYSTEM_CONFIG","CALL_PASSWORD");
            var agentPass = $.md5(pwd);
            var agentPhone = $login_name;
            wincall.fn_login(agentNum, agentPass, agentPhone, 1, 0);
//            // 记录登录的信息
//            if (window.localStorage) {
//                window.localStorage.setItem('agentNum', agentNum);
//                window.localStorage.setItem('agentPass', '123456');
//                window.localStorage.setItem('agentPhone', agentPhone);
//            }
        });


        //注销
        $('#call_btn_logout').click(function () {
            sockeIsLogin = false;
            wincall.fn_logout();
        });

        //保持
        $('call_#btn_hold').click(function () {
            wincall.fn_hold();
        });


        //呼叫外线
        $('#call_btn_dialouter').click(function () {
            var callParams = CommonUtils.getCallParams();
            var called = $('#call_mobile').val();
            wincall.fn_dialouter(called, callParams.call, callParams.group);
        });

        //挂断
        $('#call_btn_hangup').click(function () {
            wincall.fn_hangup();
        });


    });

    function eventListener(response) {

        if (typeof log_debugger !== 'undefined') {
            console.log(response);
        }
        if (response) {
            layer.msg(response.msg, {
                offset: 'rb',
                time: 2000
            });
        }

        $.each(response.disableActions, function (index, value) {
            $('#call_btn_' + value).attr('disabled', 'disabled');
        });

        $.each(response.enableActions, function (index, value) {
            $('#call_btn_' + value).removeAttr('disabled');
        });

        return;

        var $message = $('#message');
        if (response.agStatus) {
            $('#seat_state').html(response.agStatus);
        }
        if (response.queStatus) {
            $('#queue_state').html(response.queStatus);
        }
        $('#obj_content').html(response.msg);
        $message.append(response.msg + "\r\n");

        $.each(response.disableActions, function (index, value) {
            $('#btn_' + value).attr('disabled', 'disabled');
        });

        $.each(response.enableActions, function (index, value) {
            $('#btn_' + value).removeAttr('disabled');
        });

        switch (response.type) {
            case 'login_action':
                //设置技能组
                var ag_ques = wincall.fn_get_que();
                var $groupid = $('#groupid');
                $groupid.empty();
                $.each(ag_ques, function (index, item) {
                    $groupid.append($('<option value="' + item + '">' + item + '</option>'))
                });
                // 设置主叫号码
                var ag_callers = wincall.fn_get_caller();
                var $callerid = $('#callerid');
                $callerid.empty();
                $.each(ag_callers, function (index, item) {
                    $callerid.append($('<option value="' + item + '">' + item + '</option>'))
                });
                break;
            case 'ring_queue_event'://技能组分配来电
                var $caller = wincall.fn_getParam('Caller');
                var $caller_areacode = wincall.fn_getParam('CallerAreaCode');
                var $caller_areaname = wincall.fn_getParam('CallerAreaName');
                $message.append($caller + '[' + $caller_areacode + '-' + $caller_areaname + ']' + '来电\r\n');
                /**
                 * 直接调用应答函数
                 * 需要注意的是来电时有两个需要应答，一个是wincall中需要应答，
                 * 还有一个是软电话或者PSTN电话也需要应答，那么这样就可能导致操作的不方便，
                 * 因为wincall中的JS SDK是无法控制软电话和PSTN电话的，所以来电后必须手动点击接听按钮，
                 * 如此情况下，我们就在来电事件中自动调用wincall中的应答函数，这样就只需要手动点击
                 * 软电话或PSTN电话接听按钮就可以了，不需要两个都去点击接听
                 */
                wincall.fn_answer();
                /**
                 * 自定义来电的操作，可以实现弹屏的功能，例如弹出一个页面，将主叫的信息传递到页面中
                 * 实现自定义的查询功能，如根据主叫来电查询对应的客户信息等
                 */
                // 实现代码...
                break;
            case 'ring_outbound_event'://外呼来电中
                var called = wincall.fn_getParam('Called');
                var CallerAreaCode = wincall.fn_getParam('CallerAreaCode');
                var CallerAreaName = wincall.fn_getParam('CallerAreaName');
                $message.append('呼叫外线号码' + called + '[' + CallerAreaCode + '-' + CallerAreaName + ']\r\n');
                break;
            case 'call_afterwards_event'://事后处理
                var $call_afterwards_secs = wincall.fn_getParam('CallAfterwardsSecs');
                $message.append('事后处理时长为[' + $call_afterwards_secs + ']\r\n');
                break;
            case 'system_busy_event'://系统置忙
                var $busy_reason = wincall.fn_getParam('BusyReason');
                $message.append('具体置忙原因为[' + $busy_reason + ']\r\n');
                break;
            case 'update_queue_event'://更新技能组
                ag_ques = wincall.fn_get_que();
                $groupid = $('#groupid');
                $groupid.empty();
                $.each(ag_ques, function (index, item) {
                    $groupid.append($('<option value="' + item + '">' + item + '</option>'))
                });
                break;
            case 'update_caller_event'://更新主叫号码
                ag_callers = wincall.fn_get_caller();
                $callerid = $('#callerid');
                $callerid.empty();
                $.each(ag_callers, function (index, item) {
                    $callerid.append($('<option value="' + item + '">' + item + '</option>'))
                });
                break;
        }
    }
</script>
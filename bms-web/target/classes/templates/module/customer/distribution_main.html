<div class="container row">
    <div class="col-md-1 col-xs-2">
        <button id="cmmg_customer_distribution_import_btn" type="button" class="btn btn-sm btn-default" form-show="false"><i
                class="fa fa-upload"></i>&nbsp;导入
        </button>
    </div>
    <div class="col-md-1 col-xs-2">
        <button id="distribution_export_btn" type="button" class="btn btn-sm btn-default"><i class="fa fa-download"></i>&nbsp;导出
        </button>
    </div>
    <div class="col-md-1 col-xs-2">
        <button id="distribution_delete_btn" type="button" class="btn btn-sm btn-danger"><i class="fa fa-remove"></i>&nbsp;删除
        </button>
    </div>
</div>

<div class="portlet light">
    <div class="portlet-body">
        <form class="form-horizontal" action="#" id="cmmg_distribution_search_form">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="control-label col-md-3">分配时间&nbsp;:</label>
                        <div class="col-md-4" style="padding-left: 0px;padding-right: 0px;">
                            <input name="createDateBegin" size="16" type="text"
                                   class="form_datetime form-control">
                            <span class="add-on"><i class="icon-remove"></i></span>
                        </div>
                        <div class="col-md-4"
                             style="padding-left: 1px;padding-right: 0px;">
                            <input name="createDateEnd" size="16" type="text"
                                   class="form_datetime form-control"
                            >
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label class="control-label col-md-4">更新时间&nbsp;:</label>
                        <div class="col-md-4" style="padding-left: 0px;padding-right: 0px;">
                            <input name="updateDateBegin" size="16" type="text"
                                   class="form_datetime form-control">
                        </div>
                        <div class="col-md-4"
                             style="padding-left: 1px;padding-right: 0px;">
                            <input name="updateDateEnd" size="16" type="text"
                                   class="form_datetime form-control"
                            >
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label col-md-6">分配批次&nbsp;:</label>
                        <div class="col-md-6" style="padding-left: 1px;padding-right: 0px;">
                            <input type="text" name="bizId"  class="form-control"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第二行 -->
            <div class="row">
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="control-label col-md-6">客户ID&nbsp;:</label>
                        <div class="col-md-6" style="padding-left: 1px;padding-right: 0px;">
                            <input name="userNo" type="text" class="form-control"></div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="control-label col-md-6">销售员账号&nbsp;:</label>
                        <div class="col-md-6" style="padding-left: 1px;padding-right: 0px;">
                            <input type="text" name="loginName" class="form-control"></div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="control-label col-md-6">销售员&nbsp;:</label>
                        <div class="col-md-6" style="padding-left: 1px;padding-right: 0px;">
                            <input type="text" name="realName" class="form-control"></div>
                    </div>
                </div>
                <div class="col-md-2 col-md-offset-2 ">
                    <a id="cmmg_distribution_searchBtn" class="btn btn-sm btn-circle green btn-outline sbold">
                        <i class="fa fa-search"></i> 搜索 </a>
                    <a onclick="CommonUtils.reset('cmmg_distribution_search_form')"
                       class="btn btn-sm btn-circle green btn-outline sbold">
                        <i class="fa fa-print"></i> 重置 </a>
                </div>
            </div>

        </form>

        <form th:action="@{/cmmg/distribution/upload}" enctype="multipart/form-data" method="post"
              id="cmmg_customer_distribution_import_form" hidden="hidden">
            <div class="row">
                <div class="col-md-3">
                    <input type="file" name="fileName">
                </div>
                <div class="col-md-2">
                    <button id="btn_uploadimg" type="button" class="btn btn-sm btn-success"><i
                            class="fa fa-upload"></i>&nbsp;上传</button>
                </div>
            </div>
        </form>

        <div style="margin-top:10px;">
            <table class="table table-striped table-bordered table-hover" data-form="cmmg_distribution_search_form"
                   id="cmmg_distribution_table">
                <thead>
                <tr>
                    <th data-id-field="id" data-checkbox="true">id</th>
                    <th data-field="userNo">客户ID</th>
                    <th data-field="realName">销售员</th>
                    <th data-field="createDate">分配时间</th>
                    <th data-field="updateDate">更新时间</th>
                    <th data-field="bizId">分配批次</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>

    $(function () {

//        CM_Components.dictDataBinding("distribution_bizID_selector");

        var $cmmg_distribution_table = $("#cmmg_distribution_table");

        $("#distribution_export_btn").click(function () {

            var params = CommonUtils.getFormData("cmmg_distribution_search_form");

            if (!params || !params["bizId"]) {
                CM_Components.layerMsg("请输入分配批次");
                return;
            }

            var reqUrl = CM_Components.getContextAll("/distribution/export")

            var form = $("<form></form>").attr("action", reqUrl).attr("method", "get");
            form.append($("<input></input>").attr("type", "hidden").attr("name", "bizId").attr("value", params["bizId"]));
            form.appendTo('body').submit().remove();
        });

        var $cmmg_customer_distribution_import_form = $("#cmmg_customer_distribution_import_form");
        $("#cmmg_customer_distribution_import_btn").click(function () {
            var $that = $(this);
            var isShow = $that.attr("form-show");
            if (isShow === "false") {
                $cmmg_customer_distribution_import_form.show();
                $that.html("<i class=\"fa fa-upload\"></i>&nbsp;隐藏");
                $that.attr("form-show", "true");
            } else {
                $cmmg_customer_distribution_import_form.hide();
                $that.html("<i class=\"fa fa-upload\"></i>&nbsp;导入");
                $that.attr("form-show", "false");
            }
        });


        // 删除
        $("#distribution_delete_btn").click(function () {

            var rows = $cmmg_distribution_table.bootstrapTable('getSelections');

            if (!rows || rows.length == 0) {
                CM_Components.layerMsg("请选择要删除的数据！");
                return;
            }

            swal({
                    title: "确定删除?",
                    text: "",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-danger",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    closeOnConfirm: true,
                    closeOnCancel: true
                },
                function (isConfirm) {
                    if (isConfirm) {
                        var params = [];
                        $.each(rows, function (i, obj) {
                            params.push(obj.id);
                        });

                        var pageSize = $cmmg_distribution_table.bootstrapTable('getOptions').pageSize;
                        var reqUrl = CM_Components.getContextAll("/distribution/del");
                        if (rows.length == pageSize) {
                            reqUrl = CM_Components.getContextAll("/distribution/batchRemove");
                            params = CM_Components.getFormData("cmmg_distribution_search_form");
                        }
                        $.ajax({
                            url: reqUrl,
                            type: "DELETE",
                            contentType: 'application/json',
                            data: JSON.stringify(params),
                            success: function (result) {
                                if (result) {
                                    CM_Components.layerMsg(result.msg);
                                    if (result.success) {
                                        $cmmg_distribution_table.bootstrapTable('refresh', {
                                            query: CM_Components.getFormData("cmmg_distribution_search_form")
                                        });
                                    }
                                } else {
                                    CM_Components.layerMsg("删除失败");
                                }
                            }
                        });
                    }
                });
        });

        $("#cmmg_distribution_searchBtn").click(function () {
            $cmmg_distribution_table.bootstrapTable('refresh', {
                query: CM_Components.getFormData("cmmg_distribution_search_form")
            });
        });

        // 文件上传
        $("#btn_uploadimg").click(function () {

//            var fileObj = document.getElementById("FileUpload").files[0]; // js 获取文件对象
            var fileForm = $cmmg_customer_distribution_import_form.find("[type=file]");
            var fileObj = fileForm.get(0).files[0]; // js 获取文件对象
            if (typeof (fileObj) == "undefined" || fileObj.size <= 0) {
                CM_Components.layerMsg("请选择文件");
                return;
            }
            var formFile = new FormData();
            formFile.append("file", fileObj); //加入文件对象

            //第二种 ajax 提交
            var data = formFile;
            $.ajax({
                url: CM_Components.getContextAll("/distribution/upload"),
                data: data,
                type: "Post",
                dataType: "json",
                cache: false,//上传文件无需缓存
                processData: false,//用于对data参数进行序列化处理 这里必须false
                contentType: false, //必须
                success: function (result) {
                    fileForm.val("");
                    bizIdForm.val("");
                    CM_Components.layerMsg("上传完成!");
                    $cmmg_distribution_table.bootstrapTable('refresh', {
                        query: CM_Components.getFormData("cmmg_distribution_search_form")
                    });
                },
                error: function (errorMsg) {
                    fileForm.val("");
                    bizIdForm.val("");
                    CM_Components.layerMsg(errorMsg.responseText)
                }
            });
        });

        $(".form_datetime").datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            language: 'zh-CN',
            todayBtn: true,//是否在底部显示“今天”按钮
            /*showCurrentDate:true,*/
            autoclose: true,
            minView: 0
        });


        // 数据网格框架：bootstrap table
        $cmmg_distribution_table.bootstrapTable({
            method: 'get',
            url: CM_Components.getContextAll('/distribution/query'),
            cache: false,
            dataType: "json",
            striped: false,	 //使表格带有条纹
            sortable: true,
            pagination: true, //在表格底部显示分页工具栏
            pageSize: 10,
            pageNumber: 1,
            pageList: [10, 15, 20],
            idField: "id",  //标识哪个字段为id主键
            showToggle: false,   //名片格式
            cardView: false,//设置为True时显示名片（card）布局
            singleSelect: false,//复选框只能选择一条记录
            search: false,//是否显示右上角的搜索框
            clickToSelect: true,//点击行即可选中单选/复选框
            sidePagination: "server",//表格分页的位置
            // height: 350,
            queryParamsType: "",
            strictSearch: true,
            showColumns: false,     //是否显示所有的列
            showRefresh: false,     //是否显示刷新按钮
            minimumCountColumns: 2,    //最少允许的列数
            responseHandler: function (res) { //请求返回结果后的回调函数
                return {
                    "rows": res.dataList,
                    "total": res.total
                };
            },
            silent: true,  //刷新事件必须设置
            formatNoMatches: function () {  //没有匹配的结果
                return '无符合条件的记录';
            },
            rowStyle: function (row, index) {
                return {classes: "cursorHand"}
            }
        });
    });
</script>